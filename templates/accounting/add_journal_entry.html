{% extends "base.html" %}

{% block title %}Nuevo Asiento Contable{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Nuevo Asiento Contable</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="{{ url_for('accounting.journal_entries') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Volver
        </a>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <form method="POST" id="journalEntryForm">
            <!-- Información general del asiento -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="mb-3">
                        <label for="entry_date" class="form-label">Fecha del Asiento *</label>
                        <input type="date" class="form-control" id="entry_date" name="entry_date" required>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="mb-3">
                        <label for="period_id" class="form-label">Período Contable *</label>
                        <select class="form-select" id="period_id" name="period_id" required>
                            <option value="">Seleccionar período...</option>
                            {% for period in periods %}
                            <option value="{{ period.id }}">{{ period.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="mb-3">
                        <label for="reference" class="form-label">Referencia</label>
                        <input type="text" class="form-control" id="reference" name="reference" 
                               placeholder="Número de factura, recibo, etc.">
                    </div>
                </div>
            </div>
            
            <div class="mb-3">
                <label for="description" class="form-label">Descripción del Asiento *</label>
                <textarea class="form-control" id="description" name="description" rows="3" required
                          placeholder="Descripción detallada del asiento contable"></textarea>
            </div>

            <!-- Líneas del asiento contable -->
            <h5 class="mb-3">Detalle del Asiento - Partida Doble</h5>
            
            <div class="table-responsive">
                <table class="table table-bordered" id="journalDetailsTable">
                    <thead class="table-dark">
                        <tr>
                            <th width="30%">Cuenta Contable</th>
                            <th width="30%">Descripción</th>
                            <th width="15%">Debe</th>
                            <th width="15%">Haber</th>
                            <th width="10%">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="journalDetailsBody">
                        <!-- Las líneas se agregan dinámicamente -->
                    </tbody>
                    <tfoot class="table-light">
                        <tr>
                            <th colspan="2">TOTALES:</th>
                            <th class="text-end" id="totalDebit">$0.00</th>
                            <th class="text-end" id="totalCredit">$0.00</th>
                            <th></th>
                        </tr>
                    </tfoot>
                </table>
            </div>
            
            <div class="mb-3">
                <button type="button" class="btn btn-outline-primary" id="addLineBtn">
                    <i class="fas fa-plus"></i> Agregar Línea
                </button>
            </div>
            
            <!-- Balance de partida doble -->
            <div class="alert alert-info" id="balanceAlert">
                <i class="fas fa-balance-scale"></i>
                <strong>Balance:</strong> <span id="balanceMessage">Las sumas de débitos y créditos deben ser iguales</span>
            </div>
            
            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary" id="saveBtn" disabled>
                    <i class="fas fa-save"></i> Guardar Asiento
                </button>
                <a href="{{ url_for('accounting.journal_entries') }}" class="btn btn-secondary">
                    <i class="fas fa-times"></i> Cancelar
                </a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let lineCounter = 0;
const accounts = {{ accounts | tojson }};

$(document).ready(function() {
    // Agregar las primeras dos líneas automáticamente
    addJournalLine();
    addJournalLine();
    
    $('#addLineBtn').click(function() {
        addJournalLine();
    });
    
    // Evento para calcular totales al cambiar valores
    $(document).on('input', '.debit-input, .credit-input', function() {
        calculateTotals();
        validateBalance();
    });
    
    // Auto-completar para cuentas contables
    $(document).on('focus', '.account-select', function() {
        if (!$(this).hasClass('select2-hidden-accessible')) {
            $(this).select2({
                placeholder: 'Buscar cuenta...',
                allowClear: true,
                width: '100%'
            });
        }
    });
});

function addJournalLine() {
    lineCounter++;
    
    const newRow = `
        <tr id="line${lineCounter}">
            <td>
                <select class="form-select account-select" name="account_id" required>
                    <option value="">Seleccionar cuenta...</option>
                    ${accounts.map(acc => `<option value="${acc.id}">${acc.code} - ${acc.name}</option>`).join('')}
                </select>
            </td>
            <td>
                <input type="text" class="form-control" name="line_description" 
                       placeholder="Descripción de la línea">
            </td>
            <td>
                <input type="number" class="form-control debit-input text-end" name="debit" 
                       step="0.01" min="0" placeholder="0.00">
            </td>
            <td>
                <input type="number" class="form-control credit-input text-end" name="credit" 
                       step="0.01" min="0" placeholder="0.00">
            </td>
            <td>
                <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeLine(${lineCounter})" 
                        title="Eliminar línea">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        </tr>
    `;
    
    $('#journalDetailsBody').append(newRow);
    calculateTotals();
}

function removeLine(lineId) {
    if ($('#journalDetailsBody tr').length > 2) {
        $(`#line${lineId}`).remove();
        calculateTotals();
        validateBalance();
    } else {
        alert('Debe mantener al menos 2 líneas en el asiento contable.');
    }
}

function calculateTotals() {
    let totalDebit = 0;
    let totalCredit = 0;
    
    $('.debit-input').each(function() {
        const value = parseFloat($(this).val()) || 0;
        totalDebit += value;
    });
    
    $('.credit-input').each(function() {
        const value = parseFloat($(this).val()) || 0;
        totalCredit += value;
    });
    
    $('#totalDebit').text(`$${totalDebit.toFixed(2)}`);
    $('#totalCredit').text(`$${totalCredit.toFixed(2)}`);
    
    return { totalDebit, totalCredit };
}

function validateBalance() {
    const { totalDebit, totalCredit } = calculateTotals();
    const isBalanced = Math.abs(totalDebit - totalCredit) < 0.01;
    const hasValues = totalDebit > 0 && totalCredit > 0;
    
    if (isBalanced && hasValues) {
        $('#balanceAlert').removeClass('alert-warning alert-danger').addClass('alert-success');
        $('#balanceMessage').html('<i class="fas fa-check-circle"></i> ¡Asiento balanceado correctamente!');
        $('#saveBtn').prop('disabled', false);
    } else if (!hasValues) {
        $('#balanceAlert').removeClass('alert-success alert-danger').addClass('alert-info');
        $('#balanceMessage').text('Ingrese los importes de débitos y créditos');
        $('#saveBtn').prop('disabled', true);
    } else {
        $('#balanceAlert').removeClass('alert-success alert-info').addClass('alert-danger');
        $('#balanceMessage').html(`<i class="fas fa-exclamation-triangle"></i> Asiento desbalanceado. Diferencia: $${Math.abs(totalDebit - totalCredit).toFixed(2)}`);
        $('#saveBtn').prop('disabled', true);
    }
}

// Validación al enviar el formulario
$('#journalEntryForm').submit(function(e) {
    const { totalDebit, totalCredit } = calculateTotals();
    
    if (Math.abs(totalDebit - totalCredit) >= 0.01) {
        e.preventDefault();
        alert('Error: La suma de débitos debe ser igual a la suma de créditos');
        return false;
    }
    
    if (totalDebit === 0 || totalCredit === 0) {
        e.preventDefault();
        alert('Error: Debe ingresar al menos un débito y un crédito');
        return false;
    }
});

// Evitar que se pueda ingresar tanto débito como crédito en la misma línea
$(document).on('input', '.debit-input', function() {
    if ($(this).val() && parseFloat($(this).val()) > 0) {
        $(this).closest('tr').find('.credit-input').val('');
    }
});

$(document).on('input', '.credit-input', function() {
    if ($(this).val() && parseFloat($(this).val()) > 0) {
        $(this).closest('tr').find('.debit-input').val('');
    }
});
</script>

<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />

<!-- Select2 JS -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
{% endblock %}